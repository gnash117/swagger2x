//******************************************************************
//
// Copyright 2017 Open Connectivity Foundation
//
//-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
//-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

#ifndef SERVER_H_
#define SERVER_H_

#include <string>
#include <iostream>
#include <memory>
#include "ocstack.h"
#include "observer.h"
#include "OCPlatform.h"
#include "OCApi.h"

/*
 tool_version          : {{version}}
 input_file            : {{input_file}}
 version of input_file : {{json_data['info']['version']}}
 title of input_file   : {{json_data['info']['title']}}
 
 
 typical device resource tree
 
 |-- oic/res
 |
 |-- oic/p
 |-- oic/d
 |-- virtual security resources
 |
 |-- resource-1
 .
 |-- resource-n
 
 content of oic/res is determined by the resources that are tagged with OC_DISCOVERABLE
 oic/p : content is determined by the globals in the cpp file
 oic/d : content is determined by the globals in the cpp file
 
*/

using namespace std;
using namespace OC;

class IoTServer
{
    shared_ptr<PlatformConfig> m_platformConfig;
    void initializePlatform();
    void setupResources();
    void createResource(string, string, EntityHandler, OCResourceHandle&);
{% for path, path_data in json_data['paths'].items() -%}
{% for methodName, method_data in path_data.items() -%}
{% if methodName == "get" %} 
    // path: {{path}}
    OCRepresentation m{{path|variablesyntax}}Representation;
    OCResourceHandle m{{path|variablesyntax}}ResourceHandle;
    ObservationIds m{{path|variablesyntax}}Observers;
    shared_ptr<IoTObserver> m{{path|variablesyntax}}ObserverLoop;
    OCRepresentation get{{path|variablesyntax}}Representation();
    OCEntityHandlerResult m{{path|variablesyntax}}EntityHandler(shared_ptr<OCResourceRequest>);
{% endif -%}
{% endfor -%}
{% endfor %}

    // variables for the resources
{% for path, path_data in json_data['paths'].items() -%}
{% for methodName, method_data in path_data.items() -%}
{% if methodName == "get" %} 
    static string m{{path|variablesyntax}}_RESOURCE_ENDPOINT = "{{path}}";  // used path
    static string m{{path|variablesyntax}}_RESOURCE_TYPE[] = {{query_rt(json_data, path)|convert_to_c_type_array}}; // rt value (should be an array)
    static string m{{path|variablesyntax}}_RESOURCE_INTERFACE[] = {{query_if(json_data, path)|convert_to_c_type_array}}; // interface if  {% endif -%}
{% endfor -%}
{% endfor -%}


{% for path, path_data in json_data['paths'].items() %}
    // membervariables for path: {{path}}{% for var, var_data in query_properties(json_data, path).items() %}
    static string m{{path|variablesyntax}}_RESOURCE_PROPERTY_NAME{{var|variablesyntax}} = "{{var}}"; // the name for the attribute
    {{var_data.type|convert_to_c_type}} m{{path|variablesyntax}}{{var|variablesyntax}}; // the value for the attribute{% endfor -%}
{% endfor %}

    // OCPlatformInfo Contains all the platform info to be stored
    OCPlatformInfo m_platformInfo;
    
    // delete the platform information
    void DeletePlatformInfo();
    
    // set the platform information
    OCStackResult SetPlatformInfo(std::string platformID, std::string manufacturerName,
        std::string manufacturerUrl, std::string modelNumber, std::string dateOfManufacture,
        std::string platformVersion, std::string operatingSystemVersion,
        std::string hardwareVersion, std::string firmwareVersion, std::string supportUrl,
        std::string systemTime);
      
    // set the device information      
    OCStackResult SetDeviceInfo();

public:
    IoTServer();
    virtual ~IoTServer();
};

#endif /* SERVER_H_ */
